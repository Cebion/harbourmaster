<!DOCTYPE html>
<html>
<script type="text/javascript" src="jszip.min.js"></script>
<script type="text/javascript" src="FileSaver.min.js"></script>

<head>
  <title>Generate JSON</title>
  <style>
    form {
      max-width: 800px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-gap: 10px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    input[type="text"],
    select,
    textarea,
    input[type="number"] {
      width: 100%;
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 16px;
    }

    select[multiple] {
      height: 120px;
    }

    button {
      margin-top: 10px;
      width: 100%;
      padding: 10px 20px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
    }

    button:hover {
      background-color: #3e8e41;
    }

    #json {
      margin-top: 20px;
      white-space: pre-wrap;
      word-wrap: break-word;
      font-family: monospace;
      font-size: 14px;
    }
  </style>
</head>

<body>
  <form>
    <label for="file-input">Upload JSON</label>
    <input type="file" id="file-input" name="file-input" accept=".json" />
    <label for="zip-input">Upload Zip</label>
    <input type="file" id="zip-input" name="zip-input" accept=".zip" />

    <label for="port-title">Port Title:</label>
    <input type="text" id="port-title" name="port-title" required>

    <label for="script-name">Script Name:</label>
    <input type="text" id="script-name" name="script-name" required>

    <label for="directory-name">Directory Name:</label>
    <input type="text" id="directory-name" name="directory-name" required>

    <label for="genres">Genres:</label>
    <select id="genres" name="genres" multiple>
      <option value="action">Action</option>
      <option value="adventure">Adventure</option>
      <option value="casino/card">Casino/Card</option>
      <option value="fps">First Person Shooter (FPS)</option>
      <option value="platformer">Platformer</option>
      <option value="puzzle">Puzzle</option>
      <option value="racing">Racing</option>
      <option value="rhythm">Rhythm</option>
      <option value="rpg">Role-playing game (RPG)</option>
      <option value="simulation">Simulation</option>
      <option value="sports">Sports</option>
      <option value="strategy">Strategy</option>
      <option value="visual novel">Visual Novel</option>
      <option value="other">Other</option>
    </select>

    <label for="description">Description:</label>
    <textarea id="description" name="description" required></textarea>

    <label for="instructions">Instructions:</label>
    <textarea id="instructions" name="instructions" required></textarea>

    <label for="porter">Porter:</label>
    <input type="text" id="porter" name="porter" required>

    <label for="blank">&nbsp;</label>
    <label for="ready-to-run">
      <input type="checkbox" id="ready-to-run" name="ready-to-run">
      Ready to Run
    </label>

    <label for="runtime">Runtime:</label>
    <select id="runtime" name="runtime">
      <option value="blank">None (the usual option)</option>
      <optgroup label="Mono">
        <option value="mono-6.12.0.122-aarch64.squashfs">Mono (6.12.0.112)</option>
      </optgroup>
      <optgroup label="GoDot / FRT">
        <option value="frt_2.1.6.squashfs">GoDot / FRT 2.1.6</option>
        <option value="frt_3.0.6_v1.squashfs">GoDot / FRT 3.0.6</option>
        <option value="frt_3.1.2.squashfs">GoDot / FRT 3.1.2</option>
        <option value="frt_3.2.3.squashfs">GoDot / FRT 3.2.4</option>
        <option value="frt_3.3.4.squashfs">GoDot / FRT 3.3.4</option>
        <option value="frt_3.4.5.squashfs">GoDot / FRT 3.4.5</option>
        <option value="frt_3.5.2.squashfs">GoDot / FRT 3.5.2</option>
      </optgroup>
    </select>

    <label for="blank">&nbsp;</label>
    <button type="button" id="generate-json">Generate JSON</button>
    <label for="blank">&nbsp;</label>
    <button type="button" id="download-json">Download JSON</button>
    <label for="blank">&nbsp;</label>
    <button type="button" id="download-zip">Download Zip</button>
  </form>
  <div id="json"></div>


  <script>
    function downloadJson() {
      var file = new Blob([document.getElementById("json").innerHTML], { type: "application/json" });
      if (window.navigator.msSaveOrOpenBlob) // IE10+
        window.navigator.msSaveOrOpenBlob(file, filename);
      else { // Others
        var a = document.createElement("a"),
          url = URL.createObjectURL(file);
        a.href = url;
        a.download = document.getElementById("directory-name").value + ".port.json";
        document.body.appendChild(a);
        a.click();
        setTimeout(function () {
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);
        }, 0);
      }
    }


    function analyzePort(zip) {
      portJson = {};
      attr = {};
      itemsList = [];
      zip.forEach(function (relativePath, zipEntry) {  // 2) print entries
        if (!zipEntry.name.includes("/")) {
          // files at the root directory
          itemsList.push(zipEntry.name)
        }
        else {
          if (zipEntry.dir) {
            if (zipEntry.name.split("/")[1] == "") {
              itemsList.push(zipEntry.name.slice(0, zipEntry.name.length - 1));
            }
          }

        }
      });
      portJson.items = itemsList;
      portJson.attr = attr;
      portJson.attr.title = "";
      portJson.attr.porter = "";
      portJson.attr.desc = "";
      portJson.attr.inst = "";
      portJson.attr.genres = [];
      portJson.attr.rtr = false;
      portJson.attr.runtime = "blank"
      return JSON.stringify(portJson);
    }

    function readJson() {
      input = document.getElementById("file-input")
      var file = input.files[0];
      if (!file) {
        return;
      }
      var reader = new FileReader();
      reader.onload = function (e) {
        var contents = e.target.result;
        loadJson(contents);
      };
      reader.readAsText(file);
    }

    function readZip() {
      input = document.getElementById("zip-input")
      var file = input.files[0];
      if (!file) {
        return;
      }
      var jsonIncluded = false;
      JSZip.loadAsync(file)                                   // 1) read the Blob
        .then(function (zip) {
          zip.forEach(function (relativePath, zipEntry) {  // 2) print entries
            if (zipEntry.name.includes("json")) {
              jsonIncluded = true;
              zip.files[zipEntry.name].async("string")
                .then(function (data) {
                  loadJson(data);
                  zip = null;
                });
            }
          });
        }).then(function () {
          if (!jsonIncluded) {
            JSZip.loadAsync(file)                                   // 1) read the Blob
              .then(function (zip) {
                var portJson = analyzePort(zip);
                //console.log(portJson);
                loadJson(portJson);
              });
          }
        });
    }

    function downloadZip() {
      input = document.getElementById("zip-input")
      var file = input.files[0];
      if (!file) {
        return;
      }
      JSZip.loadAsync(file)                                   // 1) read the Blob
        .then(function (zip) {
          portJson = generateJSON();
          name = "";
          for (i in portJson.items) {
            if (!portJson.items[i].includes(".sh")) {
              name = portJson.items[i];
            }
          }
          zip.file(name + "/" + name + ".port.json", JSON.stringify(portJson));
          zip.generateAsync({ type: "blob" }).then(function (blob) { // 1) generate the zip file
            saveAs(blob, name + ".zip");                          // 2) trigger the download
          }, function (err) {
            console.log(err);
          });
        });
    }

    function loadJson(contents) {
      var json = JSON.parse(contents);
      var title = document.getElementById('port-title');
      title.value = json.attr.title;
      var scriptNames = [];
      var directory = "";
      for (i in json.items) {
        if (json.items[i].includes(".sh")) {
          scriptNames.push(json.items[i]);
        }
        else {
          directory = json.items[i];
        }

      }
      genres = document.getElementById("genres");
      Array.from(genres.options).forEach(function (option) {

        option.selected = json.attr.genres.includes(option.value);

      });
      var name = document.getElementById('script-name');
      name.value = scriptNames.join(",");
      var directoryName = document.getElementById('directory-name');
      directoryName.value = directory;
      var porter = document.getElementById('porter');
      porter.value = json.attr.porter;
      var description = document.getElementById('description');
      description.value = json.attr.desc;
      var instructions = document.getElementById('instructions');
      instructions.value = json.attr.inst;
      var runtime = document.getElementById('runtime');
      runtime.value = json.attr.runtime;
      var rtr = document.getElementById('ready-to-run');
      rtr.checked = json.attr.rtr;
    }

    document.getElementById('file-input')
      .addEventListener('change', readJson, false);

    document.getElementById('zip-input')
      .addEventListener('change', readZip, false);

    document.getElementById('download-json')
      .addEventListener('click', downloadJson, false);

    document.getElementById('download-zip')
      .addEventListener('click', downloadZip, false);

    function validateInputs() {
      // TODO: fix validation :(

      return true;

      // return scriptNameValid && directoryNameValid;
    }

    document.getElementById("generate-json").addEventListener("click", function () {
      if (validateInputs()) {
        setJSON(generateJSON());
      }
    });

    function setJSON(json) {
      document.getElementById("json").innerHTML = JSON.stringify(json, null, 2);
    }

    function generateJSON() {
      var portTitle = document.getElementById("port-title").value;
      var scriptNames = document.getElementById("script-name").value.split(",");
      var directoryName = document.getElementById("directory-name").value;
      var genres = Array.from(document.getElementById("genres").selectedOptions).map(o => o.value);
      var description = document.getElementById("description").value;
      var instructions = document.getElementById("instructions").value;
      var porter = document.getElementById("porter").value;
      var runtime = document.getElementById("runtime").value;
      var readyToRun = document.getElementById("ready-to-run").checked;

      runtime = runtime.length === 0 ? null : runtime;

      var items = [];

      for (i in scriptNames) {
        items.push(scriptNames[i]);
      }

      items.push(directoryName);

      var data = {
        items,
        "attr": {
          "title": portTitle,
          "porter": porter,
          "desc": description,
          "inst": instructions,
          "genres": genres,
          "rtr": readyToRun,
          "runtime": runtime
        }
      }

      return data;
    }
  </script>
</body>

</html>
